<!DOCTYPE HTML>
<html>
<head>
<meta charset="utf-8">
<title>SignalsLite Tests</title>
<script src="qunit/qunit.js"></script>
<script src="../src/SignalLite.js"></script>
<link href="qunit/qunit.css" rel="stylesheet" type="text/css">
</head>

<body>
<h1 id="qunit-header">SignalsLite Tests</h1>
<h2 id="qunit-banner"></h2>
<h2 id="qunit-userAgent"></h2>
<ol id="qunit-tests"></ol>
<script>
(function() { "use strict";

var tested = new SignalLite();

module("SignalsLite");

test( "Basic Requirements", function() {
	expect(4);
	ok( Function.prototype.apply, "Function.apply()" );
	ok( (function named() {
			ok( named, "Named inline function" );
			return true;
		})(),
		"Named inline function 2"
	);
	var T;
	(function() {
		T=function T(){}
		T.prototype.test = 1;
	})();
	ok((new T).test, "Exported T should have prototype methods");
});

test( "after setup, with 0 listeners", function()
{
	expect(2);
	var signaled = new SignalLite();
	
	equal(
		signaled.first, signaled.last,
		"after init, SignalLite.first and SignalLite.last should be equal."
	);
	
	strictEqual(
		signaled.first, signaled.last,
		"after init, SignalLite.first and SignalLite.last should be strictly equal."
	);
});

test("IE7/IE8 - object incorrectness", function()
{
	var signaled = new SignalLite();
	var listener = function() {};
	
	ok( signaled, "signaled exists" );
	ok( signaled.has, "signaled.has exists");
});

test("add, remove, has listener", function()
{
	var signaled = new SignalLite();
	var listener = function() {};
	var listener2 = function() {};
	
	ok( !signaled.has(listener),
		"signaled shouldn't has listener" );
	strictEqual( signaled.getLength(), 0,
		"signaled should has 0 listeners" );
	
	signaled.add( listener );
	strictEqual( signaled.getLength(), 1,
		"signaled should has 1 listener" );
	ok( signaled.has(listener),
		"signaled should has listener" );
	
	signaled.add( listener );
	strictEqual( signaled.getLength(), 1,
		"signaled should have 1 listener after adding a previously added listener again");
	
	signaled.add( listener2 );
	ok( signaled.has( listener2 ),
		"signaled should has listener2" );
	strictEqual( signaled.getLength(), 2,
		"signaled should have 2 listeners after adding a second listener");
	signaled.remove(listener2);
	strictEqual( signaled.getLength(), 1,
		"signaled should have 1 listener after removing second listener");
	
	signaled.remove(listener);
	ok( !signaled.has(listener),
		"signaled shouldn't have listener" );
	strictEqual( signaled.getLength(), 0,
		"signaled should have 0 listeners");
	
	signaled.remove(listener);
});

test("normal dispatching", function()
{
	var signaled = new SignalLite();
	
	var dispatchedCount = 0;
	var listener = function() {
		dispatchedCount++;
	};
	
	signaled.add( listener );
	
	equal( dispatchedCount, 0, "dispatchedCount should be 0 before dispatch" );
	
	signaled.dispatch();
	equal( dispatchedCount, 1, "dispatchedCount should be 1 after one dispatch" );
	
	signaled.dispatch();
	equal( dispatchedCount, 2, "dispatchedCount should be 2 after two dispatches" );
	
	signaled.remove( listener );
});
test("once dispatching", function()
{
	var signaled = new SignalLite();
	
	var dispatchedCount = 0;
	signaled.once( function() {
		dispatchedCount++;
	} );
	
	strictEqual( dispatchedCount, 0, "dispatchedCount should be 0 before once dispatch" );
	strictEqual( signaled.getLength(), 1, "signaled should has 1 listener" );
	strictEqual( dispatchedCount, 0, "dispatchedCount should be 0 before dispatch" );
	
	signaled.dispatch();
	strictEqual( dispatchedCount, 1, "dispatchedCount should be 1 after one dispatch" );
	strictEqual( signaled.getLength(), 0, "signaled should has 0 listeners" );
	
	signaled.dispatch();
	strictEqual( dispatchedCount, 1, "dispatchedCount should be 1 after two dispatches" );
});

test("dispatching with arguments", function() {
	
	var signaled = new SignalLite();
	
	function listener( string, number, array ) {
		strictEqual( string, "", "argument should be a string");
		strictEqual( number, 0, "argument should be a number");
		deepEqual( array, [0,1,"3"], "argument should be an array[0,1,\"3\"]");
	}
	
	signaled.add( listener );
	signaled.dispatch( "", 0, [0,1,"3"] );
	
} );
test("dispatching with thisArg", function() {
	
	var target = {};
	var target2 = {};
	var signaled = new SignalLite( target );
	
	signaled.add( function listener() {
		equal( target, this, "this should equal target" );
		signaled.remove( listener );
	} );
	signaled.dispatch();
	
	signaled.add( function listener() {
		notEqual( target, this, "this should not equal target");
		equal( target2, this, "this should equal target2");
		signaled.remove( listener );
	}, target2 );
	signaled.dispatch();
	
	signaled.once( function listener() {
		notEqual( target, this, "this should not equal target");
		equal( target2, this, "this should equal target2");
	}, target2 );
	signaled.dispatch();
} );
	
})();
</script>
</body>
</html>
